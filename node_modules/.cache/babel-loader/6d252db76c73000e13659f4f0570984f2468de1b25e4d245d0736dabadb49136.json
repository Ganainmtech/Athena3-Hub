{"ast":null,"code":"import { isBrowser, getLocation, getQueryString, detectEnv, appendToQueryString } from \"@walletconnect/utils\";\nimport NetworkMonitor from \"./network\";\nconst WS = typeof global.WebSocket !== \"undefined\" ? global.WebSocket : require(\"ws\");\nclass SocketTransport {\n  constructor(opts) {\n    this.opts = opts;\n    this._queue = [];\n    this._events = [];\n    this._subscriptions = [];\n    this._protocol = opts.protocol;\n    this._version = opts.version;\n    this._url = \"\";\n    this._netMonitor = null;\n    this._socket = null;\n    this._nextSocket = null;\n    this._subscriptions = opts.subscriptions || [];\n    this._netMonitor = opts.netMonitor || new NetworkMonitor();\n    if (!opts.url || typeof opts.url !== \"string\") {\n      throw new Error(\"Missing or invalid WebSocket url\");\n    }\n    this._url = opts.url;\n    this._netMonitor.on(\"online\", () => this._socketCreate());\n  }\n  set readyState(value) {}\n  get readyState() {\n    return this._socket ? this._socket.readyState : -1;\n  }\n  set connecting(value) {}\n  get connecting() {\n    return this.readyState === 0;\n  }\n  set connected(value) {}\n  get connected() {\n    return this.readyState === 1;\n  }\n  set closing(value) {}\n  get closing() {\n    return this.readyState === 2;\n  }\n  set closed(value) {}\n  get closed() {\n    return this.readyState === 3;\n  }\n  open() {\n    this._socketCreate();\n  }\n  close() {\n    this._socketClose();\n  }\n  send(message, topic, silent) {\n    if (!topic || typeof topic !== \"string\") {\n      throw new Error(\"Missing or invalid topic field\");\n    }\n    this._socketSend({\n      topic: topic,\n      type: \"pub\",\n      payload: message,\n      silent: !!silent\n    });\n  }\n  subscribe(topic) {\n    this._socketSend({\n      topic: topic,\n      type: \"sub\",\n      payload: \"\",\n      silent: true\n    });\n  }\n  on(event, callback) {\n    this._events.push({\n      event,\n      callback\n    });\n  }\n  _socketCreate() {\n    if (this._nextSocket) {\n      return;\n    }\n    const url = getWebSocketUrl(this._url, this._protocol, this._version);\n    this._nextSocket = new WS(url);\n    if (!this._nextSocket) {\n      throw new Error(\"Failed to create socket\");\n    }\n    this._nextSocket.onmessage = event => this._socketReceive(event);\n    this._nextSocket.onopen = () => this._socketOpen();\n    this._nextSocket.onerror = event => this._socketError(event);\n    this._nextSocket.onclose = () => {\n      setTimeout(() => {\n        this._nextSocket = null;\n        this._socketCreate();\n      }, 1000);\n    };\n  }\n  _socketOpen() {\n    this._socketClose();\n    this._socket = this._nextSocket;\n    this._nextSocket = null;\n    this._queueSubscriptions();\n    this._pushQueue();\n  }\n  _socketClose() {\n    if (this._socket) {\n      this._socket.onclose = () => {};\n      this._socket.close();\n    }\n  }\n  _socketSend(socketMessage) {\n    const message = JSON.stringify(socketMessage);\n    if (this._socket && this._socket.readyState === 1) {\n      this._socket.send(message);\n    } else {\n      this._setToQueue(socketMessage);\n      this._socketCreate();\n    }\n  }\n  async _socketReceive(event) {\n    let socketMessage;\n    try {\n      socketMessage = JSON.parse(event.data);\n    } catch (error) {\n      return;\n    }\n    this._socketSend({\n      topic: socketMessage.topic,\n      type: \"ack\",\n      payload: \"\",\n      silent: true\n    });\n    if (this._socket && this._socket.readyState === 1) {\n      const events = this._events.filter(event => event.event === \"message\");\n      if (events && events.length) {\n        events.forEach(event => event.callback(socketMessage));\n      }\n    }\n  }\n  _socketError(e) {\n    const events = this._events.filter(event => event.event === \"error\");\n    if (events && events.length) {\n      events.forEach(event => event.callback(e));\n    }\n  }\n  _queueSubscriptions() {\n    const subscriptions = this._subscriptions;\n    subscriptions.forEach(topic => this._queue.push({\n      topic: topic,\n      type: \"sub\",\n      payload: \"\",\n      silent: true\n    }));\n    this._subscriptions = this.opts.subscriptions || [];\n  }\n  _setToQueue(socketMessage) {\n    this._queue.push(socketMessage);\n  }\n  _pushQueue() {\n    const queue = this._queue;\n    queue.forEach(socketMessage => this._socketSend(socketMessage));\n    this._queue = [];\n  }\n}\nfunction getWebSocketUrl(_url, protocol, version) {\n  var _a, _b;\n  const url = _url.startsWith(\"https\") ? _url.replace(\"https\", \"wss\") : _url.startsWith(\"http\") ? _url.replace(\"http\", \"ws\") : _url;\n  const splitUrl = url.split(\"?\");\n  const params = isBrowser() ? {\n    protocol,\n    version,\n    env: \"browser\",\n    host: ((_a = getLocation()) === null || _a === void 0 ? void 0 : _a.host) || \"\"\n  } : {\n    protocol,\n    version,\n    env: ((_b = detectEnv()) === null || _b === void 0 ? void 0 : _b.name) || \"\"\n  };\n  const queryString = appendToQueryString(getQueryString(splitUrl[1] || \"\"), params);\n  return splitUrl[0] + \"?\" + queryString;\n}\nexport default SocketTransport;","map":{"version":3,"names":["isBrowser","getLocation","getQueryString","detectEnv","appendToQueryString","NetworkMonitor","WS","global","WebSocket","require","SocketTransport","constructor","opts","_queue","_events","_subscriptions","_protocol","protocol","_version","version","_url","_netMonitor","_socket","_nextSocket","subscriptions","netMonitor","url","Error","on","_socketCreate","readyState","value","connecting","connected","closing","closed","open","close","_socketClose","send","message","topic","silent","_socketSend","type","payload","subscribe","event","callback","push","getWebSocketUrl","onmessage","_socketReceive","onopen","_socketOpen","onerror","_socketError","onclose","setTimeout","_queueSubscriptions","_pushQueue","socketMessage","JSON","stringify","_setToQueue","parse","data","error","events","filter","length","forEach","e","queue","startsWith","replace","splitUrl","split","params","env","host","_a","_b","name","queryString"],"sources":["../../src/index.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}